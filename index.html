<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outreach Proposal Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f0f0ff 0%, #ffffff 100%);
            color: #1f1f1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #120044 0%, #3028a1 100%);
            color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .contract-length {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(18, 0, 68, 0.1);
        }

        .contract-length h3 {
            color: #120044;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .contract-buttons {
            display: flex;
            gap: 10px;
        }

        .contract-btn {
            padding: 10px 20px;
            border: 2px solid #5951ff;
            background: transparent;
            color: #5951ff;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .contract-btn.active {
            background: #5951ff;
            color: #ffffff;
        }

        .contract-btn:hover {
            background: #5951ff;
            color: #ffffff;
        }

        .add-products-section {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(18, 0, 68, 0.1);
        }

        .add-products-section h3 {
            color: #120044;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .dropdown-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .dropdown-group {
            flex: 1;
            min-width: 200px;
        }

        .dropdown-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #120044;
        }

        .dropdown {
            width: 100%;
            padding: 10px;
            border: 2px solid #d7d7d7;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            background: #ffffff;
            cursor: pointer;
        }

        .dropdown:focus {
            outline: none;
            border-color: #5951ff;
        }

        .view-controls {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(18, 0, 68, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .view-controls h3 {
            color: #120044;
            font-weight: 600;
            margin: 0;
        }

        .toggle-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: 2px solid #5951ff;
            background: transparent;
            color: #5951ff;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .toggle-btn.active {
            background: #5951ff;
            color: #ffffff;
        }

        .toggle-btn:hover {
            background: #5951ff;
            color: #ffffff;
        }

        .export-btn {
            padding: 8px 16px;
            border: 2px solid #2e7d32;
            background: #2e7d32;
            color: #ffffff;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .export-btn:hover {
            background: #1b5e20;
            border-color: #1b5e20;
        }

        .proposal-table {
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(18, 0, 68, 0.1);
            margin-bottom: 20px;
        }

        .table-header {
            background: linear-gradient(135deg, #030268 0%, #5951ff 100%);
            color: #ffffff;
            padding: 20px;
            display: grid;
            gap: 15px;
            align-items: center;
            font-weight: 600;
        }

        .table-header.edit-mode {
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
        }

        .table-header.presentation-mode {
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
        }

        .table-header.presentation-mode-no-discount {
            grid-template-columns: 2fr 1fr 1fr 1fr;
        }

        .product-row {
            display: grid;
            gap: 15px;
            padding: 20px;
            border-bottom: 1px solid #e6e6e6;
            align-items: center;
            position: relative;
        }

        .product-row.edit-mode {
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
        }

        .product-row.presentation-mode {
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
        }

        .product-row.presentation-mode-no-discount {
            grid-template-columns: 2fr 1fr 1fr 1fr;
        }

        .product-row:last-child {
            border-bottom: none;
        }

        .product-name {
            font-weight: 600;
            color: #120044;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .remove-btn {
            background: #d32f2f;
            color: #ffffff;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .remove-btn:hover {
            background: #b71c1c;
        }

        .input-field {
            padding: 8px 12px;
            border: 2px solid #d7d7d7;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            text-align: center;
            transition: border-color 0.3s ease;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: #5951ff;
        }

        .price-display {
            text-align: center;
            font-weight: 500;
        }

        .original-price {
            color: #d32f2f;
            text-decoration: line-through;
            font-size: 0.9em;
            display: block;
            margin-bottom: 3px;
        }

        .discounted-price {
            color: #120044;
            font-weight: 600;
        }

        /* Only show remove buttons in edit mode */
        .presentation-mode .remove-btn,
        .presentation-mode-no-discount .remove-btn {
            display: none;
        }

        .discount-column {
            transition: all 0.3s ease;
        }

        .discount-column.hidden {
            display: none;
        }

        .presentation-mode .seats-display,
        .presentation-mode-no-discount .seats-display {
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
        }

        .presentation-mode .discount-display {
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            color: #120044;
        }

        .totals-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .totals-section.no-savings {
            grid-template-columns: 1fr 1fr;
            justify-content: flex-end;
        }

        .total-card {
            background: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(18, 0, 68, 0.1);
        }

        .total-card.first-year {
            background: linear-gradient(135deg, #5951ff 0%, #7a7fff 100%);
            color: #ffffff;
        }

        .total-card.recurring {
            background: linear-gradient(135deg, #3028a1 0%, #5951ff 100%);
            color: #ffffff;
        }

        .total-card.savings {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: #ffffff;
            transition: all 0.3s ease;
        }

        .total-card.savings.hidden {
            display: none;
        }

        .total-card-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .total-crossed-out {
            text-decoration: line-through;
            color: #d32f2f;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .total-main {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
        }

        .savings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .savings-amount {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .implementation-row {
            background: #f7f5f2;
        }

        .voice-row {
            background: #ffffff;
        }

        .support-row {
            background: #cdcbff;
        }

        .discount-row {
            background: #e6f7e6;
        }

        /* Left-align support row content */
        .support-row .price-display {
            text-align: left;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9d9d9d;
            font-style: italic;
        }

        .custom-pricing-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .custom-pricing-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .custom-pricing-row label {
            min-width: 80px;
            font-size: 12px;
            color: #575757;
        }

        .custom-pricing-row input {
            flex: 1;
        }

        /* Hide cells for discount row */
        .discount-row .hidden-cell {
            visibility: hidden;
        }

        /* Export container for capturing */
        .export-container {
            background: transparent;
            padding: 0;
            border-radius: 0;
        }

        .export-container .proposal-table,
        .export-container .totals-section {
            margin-bottom: 20px;
        }

        .export-container .totals-section {
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .table-header,
            .product-row {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }

            .totals-section {
                grid-template-columns: 1fr;
            }

            .totals-section.no-savings {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .dropdown-container {
                flex-direction: column;
            }

            .view-controls {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Outreach Proposal Calculator</h1>
            <p>Configure your custom Outreach solution</p>
        </div>

        <div class="contract-length">
            <h3>Contract Length</h3>
            <div class="contract-buttons">
                <button class="contract-btn active" data-months="12">12 Months</button>
                <button class="contract-btn" data-months="24">24 Months</button>
                <button class="contract-btn" data-months="36">36 Months</button>
            </div>
        </div>

        <div class="add-products-section" id="add-products-section">
            <h3>Add Products & Services</h3>
            <div class="dropdown-container">
                <div class="dropdown-group">
                    <label for="outreach-dropdown">Outreach SKUs</label>
                    <select id="outreach-dropdown" class="dropdown">
                        <option value="">Select a product...</option>
                        <option value="engage">Outreach Platform: Engage ($120/user/month)</option>
                        <option value="admin">Outreach Admin ($120/user/month)</option>
                        <option value="meet">Outreach Meet ($60/user/month)</option>
                        <option value="deal">Outreach Deal ($25/user/month)</option>
                        <option value="forecast">Outreach Forecast ($25/user/month)</option>
                        <option value="amplify">Outreach Amplify ($1.20/credit)</option>
                        <option value="listener">Listener Licenses ($10/user/month)</option>
                        <option value="one-time-discount">One-time Discount</option>
                    </select>
                </div>
                <div class="dropdown-group">
                    <label for="voice-dropdown">Voice Licenses</label>
                    <select id="voice-dropdown" class="dropdown">
                        <option value="">Select a voice plan...</option>
                        <option value="voice-standard">USA & Canada Standard ($10/user/month)</option>
                        <option value="voice-premium">USA & Canada Premium ($20/user/month)</option>
                        <option value="voice-europe">Europe Full Standard ($25/user/month)</option>
                        <option value="voice-global">Global Calling Package ($300/org/month)</option>
                        <option value="voice-local">Local Presence USA & Canada ($150/org/month)</option>
                    </select>
                </div>
                <div class="dropdown-group">
                    <label for="implementation-dropdown">Implementation Services</label>
                    <select id="implementation-dropdown" class="dropdown">
                        <option value="">Select implementation...</option>
                        <option value="impl-10hr">10hr Quick Start ($2,000)</option>
                        <option value="impl-15hr">15hr Quick Start ($3,600)</option>
                        <option value="impl-full">Full Implementation (Custom)</option>
                        <option value="impl-amplify">Amplify Implementation (Custom)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="view-controls">
            <h3>Presentation Mode</h3>
            <div class="toggle-buttons">
                <button class="toggle-btn active" id="edit-mode-btn">Edit Mode</button>
                <button class="toggle-btn" id="presentation-mode-btn">Presentation Mode</button>
                <button class="toggle-btn" id="hide-discount-btn">Hide Discounts</button>
                <button class="toggle-btn" id="hide-savings-btn">Hide Savings</button>
                <button class="export-btn" id="export-png-btn">Export PNG</button>
            </div>
        </div>

        <div class="export-container" id="export-container">
            <div class="proposal-table">
                <div class="table-header edit-mode" id="table-header">
                    <div>Product/Service</div>
                    <div>Seats/Units</div>
                    <div>Price/Month</div>
                    <div class="discount-column">Discount %</div>
                    <div>Price</div>
                </div>

                <div id="products-container">
                    <div class="empty-state">
                        Add products using the dropdowns above to build your proposal
                    </div>
                </div>

                <!-- Premium Support always included -->
                <div class="product-row support-row edit-mode" data-product="support" id="support-row">
                    <div class="product-name">Premium Support: Plus Edition</div>
                    <div class="price-display">-</div>
                    <div class="price-display">Included</div>
                    <div class="price-display discount-column">-</div>
                    <div class="price-display">Free</div>
                </div>
            </div>

            <div class="totals-section" id="totals-section">
                <div class="total-card first-year">
                    <div class="total-card-header">Year 1 Total Investment</div>
                    <div id="firstYearUndiscounted" class="total-crossed-out" style="display: none;"></div>
                    <div class="total-main" id="firstYearTotal">$0</div>
                </div>
                <div class="total-card recurring">
                    <div class="total-card-header">Recurring Annual Cost</div>
                    <div id="recurringUndiscounted" class="total-crossed-out" style="display: none;"></div>
                    <div class="total-main" id="recurringTotal">$0</div>
                </div>
                <div class="total-card savings" id="savings-card">
                    <div class="total-card-header">Savings</div>
                    <div class="savings-row">
                        <span>Annual savings</span>
                        <span id="annualSavings" class="savings-amount">$0</span>
                    </div>
                    <div class="savings-row" id="termSavingsRow">
                        <span id="termSavingsLabel">Term savings (1y)</span>
                        <span id="totalSavings" class="savings-amount">$0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const products = {
            'engage': { price: 120, listPrice: 120, type: 'monthly', name: 'Outreach Platform: Engage' },
            'admin': { price: 120, listPrice: 120, type: 'monthly', name: 'Outreach Admin' },
            'meet': { price: 60, listPrice: 60, type: 'monthly', name: 'Outreach Meet' },
            'deal': { price: 25, listPrice: 25, type: 'monthly', name: 'Outreach Deal' },
            'forecast': { price: 25, listPrice: 25, type: 'monthly', name: 'Outreach Forecast' },
            'amplify': { price: 1.20, listPrice: 1.20, type: 'onetime', name: 'Outreach Amplify (Credits)', defaultSeats: 10000 },
            'listener': { price: 10, listPrice: 10, type: 'monthly', name: 'Listener Licenses' },
            'one-time-discount': { price: 0, listPrice: 0, type: 'onetime', name: 'One-time Discount', isDiscount: true },
            'voice-standard': { price: 10, listPrice: 10, type: 'monthly', name: 'USA & Canada Standard' },
            'voice-premium': { price: 20, listPrice: 20, type: 'monthly', name: 'USA & Canada Premium' },
            'voice-europe': { price: 25, listPrice: 25, type: 'monthly', name: 'Europe Full Standard' },
            'voice-global': { price: 300, listPrice: 300, type: 'monthly', name: 'Global Calling Package' },
            'voice-local': { price: 150, listPrice: 150, type: 'monthly', name: 'Local Presence USA & Canada' },
            'impl-10hr': { price: 2000, listPrice: 2000, type: 'onetime', name: '10hr Quick Start (One-Time Fee)' },
            'impl-15hr': { price: 3600, listPrice: 3600, type: 'onetime', name: '15hr Quick Start (One-Time Fee)' },
            'impl-full': { price: 5000, listPrice: 5000, type: 'onetime', name: 'Full Implementation (One-Time Fee)', customPricing: true },
            'impl-amplify': { price: 10000, listPrice: 10000, type: 'onetime', name: 'Amplify Implementation (One-Time Fee)', customPricing: true }
        };

        let contractMonths = 12;
        let addedProducts = new Set();
        let currentMode = 'edit';
        let showDiscounts = true;
        let showSavings = true;

        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            calculateTotals();
            updateSavingsLabel();
        });

        function initializeEventListeners() {
            // Contract length buttons
            document.querySelectorAll('.contract-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.contract-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    contractMonths = parseInt(this.dataset.months);
                    updateSavingsLabel();
                    calculateTotals();
                });
            });

            // Auto-add products when selected
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown.addEventListener('change', function() {
                    if (this.value && !addedProducts.has(this.value)) {
                        addProductRow(this.value);
                        addedProducts.add(this.value);
                        this.value = '';
                        updateEmptyState();
                        calculateTotals();
                    }
                });
            });

            // View mode toggles
            document.getElementById('edit-mode-btn').addEventListener('click', () => setViewMode('edit'));
            document.getElementById('presentation-mode-btn').addEventListener('click', () => setViewMode('presentation'));
            document.getElementById('hide-discount-btn').addEventListener('click', () => toggleDiscounts());
            document.getElementById('hide-savings-btn').addEventListener('click', () => toggleSavings());
            
            // Export functionality
            document.getElementById('export-png-btn').addEventListener('click', exportToPNG);
        }

        function setViewMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'edit') {
                document.getElementById('edit-mode-btn').classList.add('active');
                document.getElementById('add-products-section').style.display = 'block';
                showDiscounts = true;
                document.getElementById('hide-discount-btn').classList.remove('active');
            } else {
                document.getElementById('presentation-mode-btn').classList.add('active');
                document.getElementById('add-products-section').style.display = 'none';
            }
            
            updateTableLayout();
            updateAllDisplays();
        }

        function toggleDiscounts() {
            if (currentMode === 'edit') return;
            
            showDiscounts = !showDiscounts;
            
            if (showDiscounts) {
                document.getElementById('hide-discount-btn').classList.remove('active');
            } else {
                document.getElementById('hide-discount-btn').classList.add('active');
            }
            
            updateTableLayout();
        }

        function toggleSavings() {
            showSavings = !showSavings;
            
            const savingsCard = document.getElementById('savings-card');
            const totalsSection = document.getElementById('totals-section');
            const hideSavingsBtn = document.getElementById('hide-savings-btn');
            
            if (showSavings) {
                savingsCard.classList.remove('hidden');
                totalsSection.classList.remove('no-savings');
                hideSavingsBtn.classList.remove('active');
            } else {
                savingsCard.classList.add('hidden');
                totalsSection.classList.add('no-savings');
                hideSavingsBtn.classList.add('active');
            }
        }

        function exportToPNG() {
            // Prompt for custom filename
            const customerName = prompt('Enter customer/proposal name:', '');
            
            // If user cancels, exit function
            if (customerName === null) {
                return;
            }
            
            // Create filename
            let filename;
            if (customerName && customerName.trim()) {
                // Clean the customer name for filename (remove special characters)
                const cleanName = customerName.trim().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-');
                filename = `${cleanName}-Outreach-Proposal-${new Date().toISOString().split('T')[0]}.png`;
            } else {
                filename = `Outreach-Proposal-${new Date().toISOString().split('T')[0]}.png`;
            }
            
            const exportContainer = document.getElementById('export-container');
            
            // Configure html2canvas options for transparency
            const options = {
                backgroundColor: null, // This makes the background transparent
                useCORS: true,
                allowTaint: false,
                logging: false,
                scale: 2, // High DPI for crisp output
                width: exportContainer.scrollWidth,
                height: exportContainer.scrollHeight
            };

            html2canvas(exportContainer, options).then(canvas => {
                // Create download link
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).catch(error => {
                console.error('Export failed:', error);
                alert('Export failed. Please try again.');
            });
        }

        function updateTableLayout() {
            const header = document.getElementById('table-header');
            const supportRow = document.getElementById('support-row');
            const allRows = document.querySelectorAll('.product-row[data-product]');
            
            // Remove all mode classes
            header.classList.remove('edit-mode', 'presentation-mode', 'presentation-mode-no-discount');
            allRows.forEach(row => {
                row.classList.remove('edit-mode', 'presentation-mode', 'presentation-mode-no-discount');
            });
            
            // Show/hide discount columns
            const discountColumns = document.querySelectorAll('.discount-column');
            
            if (currentMode === 'edit') {
                header.classList.add('edit-mode');
                allRows.forEach(row => row.classList.add('edit-mode'));
                discountColumns.forEach(col => col.classList.remove('hidden'));
            } else if (currentMode === 'presentation' && showDiscounts) {
                header.classList.add('presentation-mode');
                allRows.forEach(row => row.classList.add('presentation-mode'));
                discountColumns.forEach(col => col.classList.remove('hidden'));
            } else {
                header.classList.add('presentation-mode-no-discount');
                allRows.forEach(row => row.classList.add('presentation-mode-no-discount'));
                discountColumns.forEach(col => col.classList.add('hidden'));
            }
        }

        function addProductRow(productKey) {
            const product = products[productKey];
            const container = document.getElementById('products-container');
            
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const row = document.createElement('div');
            row.className = 'product-row edit-mode';
            row.dataset.product = productKey;

            if (productKey.startsWith('voice-')) {
                row.classList.add('voice-row');
            } else if (productKey.startsWith('impl-')) {
                row.classList.add('implementation-row');
            } else if (productKey === 'one-time-discount') {
                row.classList.add('discount-row');
            }

            const maxSeats = (productKey === 'voice-global' || productKey === 'voice-local' || productKey.startsWith('impl-') || productKey === 'one-time-discount') ? 1 : 999;
            const defaultSeats = product.defaultSeats || 1;

            let rowHTML;
            
            if (productKey === 'one-time-discount') {
                // One-time discount uses same grid but hides irrelevant cells
                rowHTML = `
                    <div class="product-name">
                        <button class="remove-btn" onclick="removeProduct('${productKey}')" title="Remove product">×</button>
                        ${product.name}
                    </div>
                    <div class="hidden-cell">-</div>
                    <div class="hidden-cell">-</div>
                    <div class="discount-column hidden-cell">-</div>
                    <div class="price-cell">
                        <input type="text" class="input-field discount-price-input" value="0" placeholder="Discount amount">
                        <div class="price-display-static" style="display: none;">$0.00</div>
                    </div>
                `;
            } else {
                const priceCell = product.customPricing ? `
                    <div class="price-cell">
                        <div class="custom-pricing-container" style="display: block;">
                            <div class="custom-pricing-row">
                                <label>List:</label>
                                <input type="text" class="input-field list-price-input" value="${product.listPrice}">
                            </div>
                            <div class="custom-pricing-row">
                                <label>Price:</label>
                                <input type="text" class="input-field price-input" value="${product.price}">
                            </div>
                        </div>
                        <div class="price-display-static" style="display: none;">$${product.price.toFixed(2)}</div>
                    </div>
                ` : `
                    <div class="price-cell">
                        <input type="text" class="input-field price-input" value="${product.price}">
                        <div class="price-display-static" style="display: none;">$${product.price.toFixed(2)}</div>
                    </div>
                `;

                rowHTML = `
                    <div class="product-name">
                        <button class="remove-btn" onclick="removeProduct('${productKey}')" title="Remove product">×</button>
                        ${product.name}
                    </div>
                    <div class="seat-cell">
                        <input type="text" class="input-field seats-input" value="${defaultSeats}">
                        <div class="seats-display" style="display: none;">${defaultSeats}</div>
                    </div>
                    ${priceCell}
                    <div class="discount-column discount-cell">
                        <input type="text" class="input-field discount-input" value="0">
                        <div class="discount-display" style="display: none;">0%</div>
                    </div>
                    <div class="price-display total-price">$0.00</div>
                `;
            }

            row.innerHTML = rowHTML;
            container.appendChild(row);

            // Add event listeners
            const seatsInput = row.querySelector('.seats-input');
            const discountInput = row.querySelector('.discount-input');
            const priceInput = row.querySelector('.price-input');
            const listPriceInput = row.querySelector('.list-price-input');
            const discountPriceInput = row.querySelector('.discount-price-input');

            if (seatsInput) {
                seatsInput.addEventListener('input', () => {
                    updateDisplays(row);
                    calculateTotals();
                });
            }
            
            if (discountInput) {
                discountInput.addEventListener('input', function() {
                    // Allow decimal input by not constraining the value
                    const discount = parseFloat(this.value) || 0;
                    
                    if (priceInput) {
                        const listPrice = listPriceInput ? parseFloat(listPriceInput.value) || 0 : products[productKey].listPrice;
                        const newPrice = listPrice * (1 - Math.min(100, Math.max(0, discount)) / 100);
                        priceInput.value = newPrice.toFixed(2);
                    }
                    
                    updateDisplays(row);
                    calculateTotals();
                });
            }

            if (priceInput) {
                priceInput.addEventListener('input', function() {
                    const newPrice = parseFloat(this.value) || 0;
                    
                    if (discountInput) {
                        const listPrice = listPriceInput ? parseFloat(listPriceInput.value) || 0 : products[productKey].listPrice;
                        
                        if (listPrice > 0) {
                            const discount = ((listPrice - newPrice) / listPrice) * 100;
                            discountInput.value = Math.max(0, discount).toFixed(1);
                        }
                    }
                    
                    updateDisplays(row);
                    calculateTotals();
                });
            }

            if (discountPriceInput) {
                discountPriceInput.addEventListener('input', function() {
                    calculateTotals();
                });
            }

            if (listPriceInput) {
                listPriceInput.addEventListener('input', function() {
                    const listPrice = parseFloat(this.value) || 0;
                    const currentPrice = parseFloat(priceInput.value) || 0;
                    
                    if (listPrice > 0 && discountInput) {
                        const discount = ((listPrice - currentPrice) / listPrice) * 100;
                        discountInput.value = Math.max(0, discount).toFixed(1);
                    }
                    
                    updateDisplays(row);
                    calculateTotals();
                });
            }

            updateDisplays(row);
            updateTableLayout();
            calculateTotals();
        }

        function updateDisplays(row) {
            const productKey = row.dataset.product;
            
            if (productKey === 'one-time-discount') {
                const discountPriceInput = row.querySelector('.discount-price-input');
                const priceDisplayStatic = row.querySelector('.price-display-static');
                
                if (currentMode !== 'edit' && discountPriceInput && priceDisplayStatic) {
                    const value = parseFloat(discountPriceInput.value) || 0;
                    priceDisplayStatic.innerHTML = `<div style="text-align: left; font-weight: 600;">$${Math.abs(value).toLocaleString()}</div>`;
                    discountPriceInput.style.display = 'none';
                    priceDisplayStatic.style.display = 'block';
                } else if (discountPriceInput && priceDisplayStatic) {
                    discountPriceInput.style.display = 'block';
                    priceDisplayStatic.style.display = 'none';
                }
                return;
            }
            
            const product = products[productKey];
            const seatsInput = row.querySelector('.seats-input');
            const priceInput = row.querySelector('.price-input');
            const discountInput = row.querySelector('.discount-input');
            const listPriceInput = row.querySelector('.list-price-input');
            const customPricingContainer = row.querySelector('.custom-pricing-container');
            
            const seatsDisplay = row.querySelector('.seats-display');
            const priceDisplayStatic = row.querySelector('.price-display-static');
            const discountDisplay = row.querySelector('.discount-display');

            if (!priceInput || !discountInput) return;

            const seats = seatsInput ? parseInt(seatsInput.value) || 0 : 1;
            const currentPrice = parseFloat(priceInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            const listPrice = listPriceInput ? parseFloat(listPriceInput.value) || 0 : product.listPrice;

            // Update static displays
            if (seatsDisplay) seatsDisplay.textContent = seats;
            if (discountDisplay) discountDisplay.textContent = discount + '%';

            // Update price display with left-aligned styling for presentation mode
            if (priceDisplayStatic) {
                if (currentMode !== 'edit' && currentPrice < listPrice) {
                    priceDisplayStatic.innerHTML = `
                        <div style="text-align: left;">
                            <div class="original-price">$${listPrice.toFixed(2)}</div>
                            <div class="discounted-price">$${currentPrice.toFixed(2)}</div>
                        </div>
                    `;
                } else if (currentMode !== 'edit') {
                    priceDisplayStatic.innerHTML = `<div style="text-align: left; font-weight: 600;">$${currentPrice.toFixed(2)}</div>`;
                }
            }

            // Toggle between input and display based on mode
            if (currentMode === 'edit') {
                if (seatsInput) seatsInput.style.display = 'block';
                if (priceInput) priceInput.style.display = 'block';
                if (discountInput) discountInput.style.display = 'block';
                if (customPricingContainer) customPricingContainer.style.display = 'block';
                if (seatsDisplay) seatsDisplay.style.display = 'none';
                if (priceDisplayStatic) priceDisplayStatic.style.display = 'none';
                if (discountDisplay) discountDisplay.style.display = 'none';
            } else {
                if (seatsInput) seatsInput.style.display = 'none';
                if (priceInput) priceInput.style.display = 'none';
                if (discountInput) discountInput.style.display = 'none';
                if (customPricingContainer) customPricingContainer.style.display = 'none';
                if (seatsDisplay) seatsDisplay.style.display = 'block';
                if (priceDisplayStatic) priceDisplayStatic.style.display = 'block';
                if (discountDisplay) discountDisplay.style.display = 'block';
            }
        }

        function updateAllDisplays() {
            document.querySelectorAll('.product-row[data-product]').forEach(row => {
                if (row.dataset.product !== 'support') {
                    updateDisplays(row);
                }
            });
        }

        function removeProduct(productKey) {
            const row = document.querySelector(`[data-product="${productKey}"]`);
            if (row && productKey !== 'support') {
                row.remove();
                addedProducts.delete(productKey);
                updateEmptyState();
                calculateTotals();
            }
        }

        function updateEmptyState() {
            const container = document.getElementById('products-container');
            const productRows = container.querySelectorAll('.product-row');
            
            if (productRows.length === 0) {
                container.innerHTML = '<div class="empty-state">Add products using the dropdowns above to build your proposal</div>';
            }
        }

        function calculateTotals() {
            let monthlyRecurring = 0;
            let oneTimeTotal = 0;
            let originalMonthlyRecurring = 0;
            let originalOneTimeTotal = 0;
            let oneTimeDiscounts = 0;

            document.querySelectorAll('.product-row[data-product]').forEach(row => {
                const productKey = row.dataset.product;
                if (productKey === 'support') return;
                
                if (productKey === 'one-time-discount') {
                    const discountPriceInput = row.querySelector('.discount-price-input');
                    if (discountPriceInput) {
                        const discountAmount = Math.abs(parseFloat(discountPriceInput.value) || 0);
                        oneTimeDiscounts += discountAmount;
                    }
                    return;
                }

                const seatsInput = row.querySelector('.seats-input');
                const priceInput = row.querySelector('.price-input');
                const listPriceInput = row.querySelector('.list-price-input');
                const totalPriceDiv = row.querySelector('.total-price');

                if (!priceInput || !totalPriceDiv) return;

                const seats = seatsInput ? parseInt(seatsInput.value) || 0 : 1;
                const currentPrice = parseFloat(priceInput.value) || 0;
                const product = products[productKey];
                const listPrice = listPriceInput ? parseFloat(listPriceInput.value) || 0 : product.listPrice;
                
                if (!product || (seatsInput && seats === 0)) {
                    totalPriceDiv.innerHTML = '$0.00';
                    return;
                }
                
                let originalTotal, discountedTotal;
                if (product.type === 'monthly') {
                    originalTotal = listPrice * seats * 12;
                    discountedTotal = currentPrice * seats * 12;
                } else {
                    originalTotal = listPrice * seats;
                    discountedTotal = currentPrice * seats;
                }

                // Show crossed out price if discounted - left aligned for presentation
                if (currentPrice < listPrice) {
                    totalPriceDiv.innerHTML = `
                        <div style="text-align: left;">
                            <div class="original-price">$${originalTotal.toLocaleString()}</div>
                            <div class="discounted-price">$${discountedTotal.toLocaleString()}</div>
                        </div>
                    `;
                } else {
                    totalPriceDiv.innerHTML = `<div style="text-align: left; font-weight: 600;">$${Math.abs(discountedTotal).toLocaleString()}</div>`;
                }

                if (product.type === 'monthly') {
                    monthlyRecurring += discountedTotal;
                    originalMonthlyRecurring += originalTotal;
                } else {
                    oneTimeTotal += discountedTotal;
                    originalOneTimeTotal += originalTotal;
                }
            });

            updateAllDisplays();

            const annualRecurring = monthlyRecurring;
            const originalAnnualRecurring = originalMonthlyRecurring;
            const firstYearTotal = annualRecurring + oneTimeTotal - oneTimeDiscounts;
            const originalFirstYearTotal = originalAnnualRecurring + originalOneTimeTotal;

            // Calculate savings correctly - include one-time discounts
            const annualRecurringSavings = originalAnnualRecurring - annualRecurring;
            const implementationSavings = (originalOneTimeTotal - oneTimeTotal) + oneTimeDiscounts;
            const totalTermSavings = (annualRecurringSavings * contractMonths / 12) + implementationSavings;

            // Update displays
            updateTotalDisplay('firstYearUndiscounted', 'firstYearTotal', originalFirstYearTotal, firstYearTotal);
            updateTotalDisplay('recurringUndiscounted', 'recurringTotal', originalAnnualRecurring, annualRecurring);
            
            const annualSavingsEl = document.getElementById('annualSavings');
            const totalSavingsEl = document.getElementById('totalSavings');
            const termSavingsRow = document.getElementById('termSavingsRow');
            
            if (annualSavingsEl) annualSavingsEl.textContent = `$${annualRecurringSavings.toLocaleString()}`;
            if (totalSavingsEl) totalSavingsEl.textContent = `$${totalTermSavings.toLocaleString()}`;
            
            // ALWAYS show the term savings row
            if (termSavingsRow) {
                termSavingsRow.style.display = 'flex';
            }
        }

        function updateTotalDisplay(undiscountedId, totalId, originalAmount, discountedAmount) {
            const undiscountedEl = document.getElementById(undiscountedId);
            const totalEl = document.getElementById(totalId);
            
            if (undiscountedEl) {
                undiscountedEl.textContent = `$${originalAmount.toLocaleString()}`;
                undiscountedEl.style.display = originalAmount > discountedAmount ? 'block' : 'none';
            }
            
            if (totalEl) {
                totalEl.textContent = `$${discountedAmount.toLocaleString()}`;
            }
        }

        function updateSavingsLabel() {
            const label = document.getElementById('termSavingsLabel');
            if (label) {
                label.textContent = `Term savings (${contractMonths/12}y)`;
            }
        }
    </script>
</body>
</html>
